<!DOCTYPE html>
<html lang=en>
<head>
  <title>Startpage</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--bg:#333;--tc:#eee;--bd:#444;--bda:rgba(68,68,68,.3);--bb:#d51a7e;--ab:#eee;--hc:#009696;--bdb:linear-gradient(to bottom,rgba(0,0,0,.5) 0,rgba(0,0,0,.1) 50%,rgba(0,0,0,.5)100%) repeat fixed 0 0,url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAVhJREFUeNpslNmOwjAMRdMNCvSlPLS/Oz/MG1XZWoZjdKpoNJZKYsfL9XVC0ff9T/pIWZYs6f1+p6Io0rqusSLLssQ5ujbk8XikkoCqqsKJPYHoOqLnyV+v17Zirz+yVWDd7XZpmqb0fD7D6Xg8RjL8EJKLOD6ChNk0TaxUBR6VSGY1dFGKriYjRhFQjQDFMxHkLUWC+/2+wSKYw8PhsPUJKuwiogjJCEavccCAA4no/XQ6BRcIK0VsIyeYuBojQaw4WnEcx9hfLpetlXzE6jWKo2vbNiDO8xzJDBC2HDmNmI4kenEk7e/8LeLIQRfkXq/XUPb7fTj+dxslmWB5ut1uX16Aanbn6zRMpLCnEAloM7iTg9xZgqzqzbMFbUyo5CfvzWDhKhbBDtn4Mvp6GIbY0I+vzXZ8Az40X2TXdfHFTQQBvci0j8RWck5sl4Tn8zl9/grSrwADAG23WlAleCEjAAAAAElFTkSuQmCC) repeat fixed 0 0 var(--bg)}
    @media (prefers-color-scheme: light) {:root{--bg:#eee;--tc:#333;--bd:#d4d4d4;--bda:rgb(212,212,212,.4);--bb:#1a65d5;--hc:transparent;--bdb:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYxIDY0LjE0MDk0OSwgMjAxMC8xMi8wNy0xMDo1NzowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNS4xIFdpbmRvd3MiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NzIyNUZFQ0Q3QkY1MTFFQUFGNDlEODY3OTIyQ0U2NTIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NzIyNUZFQ0U3QkY1MTFFQUFGNDlEODY3OTIyQ0U2NTIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3MjI1RkVDQjdCRjUxMUVBQUY0OUQ4Njc5MjJDRTY1MiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo3MjI1RkVDQzdCRjUxMUVBQUY0OUQ4Njc5MjJDRTY1MiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pn5gWqMAAAA/UExURcXCvcbEv8TBvMK/usjFwLi1sby6tcvIw7m3ssnHwb+9uMG+udvY0tHOyM7Lxr67ttjVz9XSzOLf2czJxLu4s6tQjLoAAACSSURBVHjaNFAHDgMhDLMzmG2v6/9vbRLUCCQcPAIASBCA5IkKoUCscGyRvBTbbWxFVnGJ5WOspKJ0QPPhex4nTZl+vW2I5oKFbSd7KaRcFP15e1ClCNG0bP8JgSQHIyWxTSw14lQkrIaxZ2ZLDtgvd/jK/BSQ1ryhKU3qRdHW4fgYjmlYsPeJ+0xznj+w1/snwABL1wK8a19N8QAAAABJRU5ErkJggg==) repeat fixed 0px 0px, #fff}}
    html, body {height:100%;font-size:clamp(12px,3vw, 18px)}
    body {background:var(--bdb);font-family:system-ui;color:var(--tc);display:flex;justify-content:center;align-items:center}
    input:focus { outline:none}
    [hidden] {display:none !important}
    #c {margin:20px 0;width:clamp(320px, 500px, 100vw);margin:0 auto}
    .d{border:none;background:0 0;color:var(--tc);cursor:pointer;font-size:1rem;display:none;margin-right:.2rem}
    #mt:checked ~ #l .d {display:inline-block}
    .d:hover,#l a:hover,.m:hover,#t:hover,#n button:hover, #dl:hover, [for=up]:hover {opacity:1;filter:brightness(1.2) contrast(200%) drop-shadow(0 0 5px var(--hc))}
    .m {display: inline-block;width:24px;height:24px;cursor:grab;background-image:radial-gradient(gray 30%, transparent 40%);background-size:3px 3px;background-position:0 100%;border-radius:30%}
    .m:active {cursor:grabbing}
    .f {margin-right:.3rem;height:1.2rem;width:1.2rem;object-fit:cover}
    #mt:checked~#l .f{display:none}
    [draggable] {user-select:none;-khtml-user-drag:element;-webkit-user-drag:element}
    [draggable] input {user-select:auto}
    #l {padding:0;margin:0;list-style:none}
    #l li {margin:0;border-top:1px solid transparent;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;white-space:nowrap;align-items: center;}
    #l li.over {border-top:1px solid #3c81e7;filter:brightness(1.2)}
    #l li:last-child {border-bottom:none}
    #l li * {vertical-align: middle;}
    #l a {color:var(--tc);text-decoration:none;line-height:1.9rem;display: inline-block;}
    #n {box-sizing:border-box;background:var(--bda);color:var(--tc);overflow:hidden;transition:max-height .2s linear;max-height:0}
    #mt:checked ~ #n {max-height:15rem;}
    #n_ {padding:1rem 1rem 0}
    #n input{padding:7px;outline:0;border:none;width:100%;box-sizing:border-box;display:block;font-size:1rem}
    #add,#dl,#t,[for=up]{opacity:.9;margin:10px 0;background:var(--bb);border:none;color:var(--ab);padding:5px 15px;width:100%;height:35px;cursor:pointer;display:block;text-align:center;box-sizing:border-box;font-size:.9rem}
    #dl,[for=up]{background:transparent;color: var(--tc);}
    #dl{margin-right:1px}
    #title, #icon{transform: scale(.75);transform-origin: left bottom}
    #file {display:flex;justify-content:space-between}
    h2{font-size:1rem}
  </style>
</head>
<body>
  <div id=c>
    <input type=checkbox id=mt hidden>
    <ul id=l>
      <li draggable=true>
        <a class=link href="https://www.systemshock.org/">
          <button class=d title="Delete This Link">×</button>
          <img class=f src="https://www.google.com/s2/favicons?sz=32&domain_url=www.systemshock.org">
          <span class=title>Systemshock.org</span>
        </a>
        <i class=m title="Drag This Link To Another Position"></i>
      </li>
      <li draggable=true>
        <a class=link href="https://old.reddit.com/hot/">
          <button class=d title="Delete This Link">×</button>
          <img class=f src="https://www.google.com/s2/favicons?sz=32&domain_url=old.reddit.com">
          <span class=title>Reddit</span>
        </a>
        <i class=m title="Drag This Link To Another Position"></i>
      </li>
      <li draggable=true>
        <a class=link href="https://bandcamp.com/">
          <button class=d title="Delete This Link">×</button>
          <img class=f src="https://www.google.com/s2/favicons?sz=32&domain_url=bandcamp.com">
          <span class=title>Bandcamp</span>
        </a>
        <i class=m title="Drag This Link To Another Position"></i>
      </li>
    </ul>
    <label for=mt id=t>Manage Links</label>
    <div id=n>
      <div id=n_>
        <h2>Add New Link</h2>
        <input id=url type=text placeholder="https://" />
        <input id=title type=text placeholder="Title (optional)"/>
        <input id=icon type=text placeholder="Icon URL (optional)"/>
        <button id=add>Save New Link</button>
        <aside id=file>
          <span id=dl >&#x21e9; Download Links</span>
          <input type="file" id=up accept=".json" hidden><label for=up>Upload Links &#x21e7;</label>
        </aside>
      </div>
    </div>
  </div>
  <script>
    //--------------------Drag & Drop------------------------------
    let dragSrcEl

    function handleDragStart(e) {
      dragSrcEl = this
      e.dataTransfer.effectAllowed = 'move'
      e.dataTransfer.setData('text/html', this.outerHTML)
    }

    const dragOver = (e) =>{
      if (e.preventDefault) e.preventDefault()
      e.dataTransfer.dropEffect = 'move'
      return false
    }

    let dragEnterTarget;

    const dragEnter = (e) => {
      const target = e.target.closest('LI')
      if (target) {
        target.classList.add('over')
        dragEnterTarget = target
      } else {
        //dragged outside dropzone, cancel all meetings
        l.querySelectorAll('LI').forEach((el) => {
          el.classList.remove('over')
        })
      }
    }

    const dragLeave = (e) => {
      l.querySelectorAll('LI').forEach((el) => {
        if (el !== dragEnterTarget) el.classList.remove('over')
      })
    }

    function drop(e) {
      if (e.stopPropagation) e.stopPropagation()
      if (dragSrcEl != this) {
        this.parentNode.removeChild(dragSrcEl)
        var dropHTML = e.dataTransfer.getData('text/html')
        this.insertAdjacentHTML('beforebegin',dropHTML)
        var dropElem = this.previousSibling
        addDnDHandlers(dropElem)
      }
      this.classList.remove('over')
      save()
      if (dropElem) itemDeleteHandler(dropElem.querySelector('.d'))
      return false
    }

    const addDnDHandlers = (el) => {
      el.addEventListener('dragstart', handleDragStart)
      el.addEventListener('dragenter', dragEnter)
      el.addEventListener('dragover', dragOver)
      el.addEventListener('dragleave', dragLeave)
      el.addEventListener('drop', drop)
    }
    l.querySelectorAll('LI').forEach((el) => {
      addDnDHandlers(el)
    })
    //dragged outside dropzone
    window.addEventListener('dragenter', dragEnter)

    //----------------------Link Handling-----------------------

    //data to be saved
    const getLinksFromHtml = () => {
      const arr = []
      l.querySelectorAll('LI').forEach((el) => {
        arr.push ( {"link":el.querySelector('.link').href,"title":el.querySelector('.title').innerHTML,"icon":el.querySelector('.f').src} );
      })
      return JSON.stringify(arr.reverse())
    }

    const save = () => localStorage.setItem('sp-links', getLinksFromHtml())
    const fragmentFromString = (strHTML) => document.createRange().createContextualFragment(strHTML);
    const noWWW = (str) => str.replace("www.", "")

    //add new item from json or form
    const addNewItem = (loadUrl,loadTitle,loadIcon) => {
      const realUrl = new URL(loadUrl)
      const realTitle = loadTitle || noWWW(realUrl.hostname)
      const realIcon = loadIcon || `https://www.google.com/s2/favicons?sz=32&domain_url=${realUrl.host}`
      const searchPattern = 'https://google.com/search?'
      const frag = fragmentFromString(`
      <li draggable=true>
        <div>
          <button class=d title="Delete This Link">×</button>
          <a class=link href="${realUrl}">
            <img class=f src="${realIcon}">
            <span class=title>${realTitle}</span>
          </a>
        </div>
        <i class=m title="Drag This Link To Another Position"></i>
      </li>`)
      //add the new item at the top of the linklist and attach link handlers to it
      l.prepend(frag)
      itemDeleteHandler(l.querySelector('LI:first-of-type .d'))
      addDnDHandlers(l.querySelector('LI:first-of-type'))
    }

    //deleting items
    const itemDeleteHandler = (x) => {
      x.addEventListener('click', (e) => {
        e.currentTarget.parentElement.parentElement.remove()
        save()
      })
    }
    document.querySelectorAll('.d').forEach((x) => itemDeleteHandler(x))

    //new link form
    const addNewItemFromLinkForm = () => {
      addNewItem(url.value, title.value, icon.value)
      save()
      title.value = ''
      url.value =''
      icon.value =''
    }
    t.addEventListener('click', (e) => {
      url.focus()
      n.addEventListener('keydown', (e) => {
        if (event.keyCode == 13) addNewItemFromLinkForm()
      })
    })
    add.addEventListener('click', addNewItemFromLinkForm)

    //loading links from localstorage json or file
    const loadLinks = (str) => {
      const links = str? JSON.parse(str) : JSON.parse(localStorage.getItem('sp-links'))
      if (links) {
        l.innerHTML = ''
        links.forEach((link) => {
          addNewItem(link.link, link.title, link.icon)
        })
      }
    }
    loadLinks()

    //download
    const download = () => {
      const element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(localStorage.getItem('sp-links')))
      element.setAttribute('download', 'StartPageLinks.json')
      element.style.display = 'none'
      document.body.appendChild(element)
      element.click()
      document.body.removeChild(element)
    }
    dl.addEventListener('click', download)

    //upload
    const sel = document.getElementById('up');
    sel.addEventListener('change', (event) => {
      let str = ''
      const file = event.target.files[0];
      const reader = new FileReader()
      reader.addEventListener('load', event => {
        str = event.target.result
        loadLinks(str)
        save()
      })
      reader.readAsText(file)
    })
  </script>
</body>
</html>
